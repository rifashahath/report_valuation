version: "3.9"

# ============================================================
# Async File Processing Stack
# FastAPI + Celery + Redis + MongoDB + MailHog
# ============================================================

services:

  # ----------------------------------------------------------
  # Core infrastructure
  # ----------------------------------------------------------

  mongodb:
    image: mongo:6
    container_name: report_mongodb
    volumes:
      - mongo_data:/data/db
    ports:
      - "27018:27017"
    restart: always
    healthcheck:
      test: ["CMD", "mongosh", "--eval", "db.adminCommand('ping')"]
      interval: 10s
      timeout: 5s
      retries: 5

  redis:
    image: redis:7-alpine
    container_name: report_redis
    ports:
      - "6379:6379"
    restart: always
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 3s
      retries: 5

  mailhog:
    image: mailhog/mailhog:latest
    container_name: report_mailhog
    ports:
      - "1025:1025"   # SMTP
      - "8025:8025"   # Web UI  â†’  http://localhost:8025
    restart: always

  # ----------------------------------------------------------
  # FastAPI backend
  # ----------------------------------------------------------

  backend:
    build:
      context: ./api
    container_name: report_backend
    ports:
      - "8000:8000"
    env_file:
      - ./api/.env
    environment:
      MONGO_URI: mongodb://mongodb:27017
      MONGO_DB_NAME: reportdb
      CELERY_BROKER_URL: redis://redis:6379/0
      CELERY_RESULT_BACKEND: redis://redis:6379/0
      SMTP_HOST: mailhog
      SMTP_PORT: "1025"
      UPLOAD_DIR: /app/uploads
    depends_on:
      mongodb:
        condition: service_healthy
      redis:
        condition: service_healthy
    volumes:
      - shared_uploads:/app/uploads   # shared with workers
      - ./api:/app                    # live-reload in dev
    restart: always
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/health"]
      interval: 15s
      timeout: 5s
      retries: 5

  # ----------------------------------------------------------
  # Celery worker  (processes the document_processing queue)
  # ----------------------------------------------------------

  celery_worker:
    build:
      context: ./api
    container_name: report_celery_worker
    command: >
      celery -A app.celery_app:celery_app worker
        --loglevel=info
        --queues=document_processing
        --concurrency=2
        --hostname=worker@%h
    env_file:
      - ./api/.env
    environment:
      MONGO_URI: mongodb://mongodb:27017
      MONGO_DB_NAME: reportdb
      CELERY_BROKER_URL: redis://redis:6379/0
      CELERY_RESULT_BACKEND: redis://redis:6379/0
      SMTP_HOST: mailhog
      SMTP_PORT: "1025"
      UPLOAD_DIR: /app/uploads
      CELERY_CONCURRENCY: "2"
    depends_on:
      backend:
        condition: service_healthy
      redis:
        condition: service_healthy
    volumes:
      - shared_uploads:/app/uploads   # SAME named volume as backend
      - ./api:/app
    restart: always

  # ----------------------------------------------------------
  # Celery Flower  (web dashboard for monitoring tasks)
  # http://localhost:5555
  # ----------------------------------------------------------

  flower:
    image: mher/flower:2.0
    container_name: report_flower
    command: >
      celery
        --broker=redis://redis:6379/0
        flower
        --port=5555
    ports:
      - "5555:5555"
    environment:
      CELERY_BROKER_URL: redis://redis:6379/0
      CELERY_RESULT_BACKEND: redis://redis:6379/0
    depends_on:
      - redis
    restart: always

  # ----------------------------------------------------------
  # React / Vite frontend
  # ----------------------------------------------------------

  frontend:
    build:
      context: ./web_app
    container_name: report_frontend
    ports:
      - "5173:80"
    depends_on:
      - backend
    restart: always

# ============================================================
# Volumes
# ============================================================

volumes:
  mongo_data:
  # Named volume ensures both backend and celery_worker share
  # exactly the same filesystem namespace for uploads.
  shared_uploads:
